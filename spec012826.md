# techspec.md — FDA 510(k) Review Studio v2 “Regulatory Command Center” (WOW UI)  
**Deployment Target:** Hugging Face Spaces (Streamlit, single-container)  
**Primary Goal:** Provide an agentic, human-in-the-loop workspace that accelerates FDA-style 510(k) document review by combining structured datasets (510(k), Recalls, MDR/ADR, GUDID), PDF ingestion/OCR, and a configurable multi-agent orchestration engine—wrapped in a “WOW” split-pane interface with theme/language/painter styles and strong security practices.

---

## 1. Executive Summary

The **FDA 510(k) Review Studio v2** is a Streamlit-based “Regulatory Command Center” designed to help reviewers rapidly transform unstructured submission documents into structured review-ready insights. The app delivers an interactive, visually distinctive **WOW UI** that supports:

- **Split-pane workflow**: Source Material (PDF/OCR/Raw Text) on the left, Intelligence Deck (Agents/Search/Final Report) on the right.
- **Human-in-the-loop agent chain execution**: run one agent at a time, edit prompts before execution, and edit outputs as inputs to the next agent.
- **Cross-dataset context engine**: fast fuzzy search across embedded datasets for 510(k), MDR/ADR, GUDID, and Recall records and a consolidated **360° Device View**.
- **Advanced note workflow**: an **AI Note Keeper** mode for transforming pasted/uploaded notes into organized Markdown, highlighting critical terms in Coral (#FF7F50), and applying user-defined keyword colors.
- **Security-first API handling**: API keys can be provided via environment variables or securely entered in-session via password inputs; keys are never printed and are stored only in `st.session_state`.

The system’s key differentiator is the “WOW Factor”: a “Painter’s Studio” glassmorphism UI with **light/dark themes**, **English/Traditional Chinese**, and **20 painter-inspired style palettes** with a “Jackpot” randomizer, plus status indicators and an interactive dashboard.

---

## 2. System Architecture Overview

### 2.1 Single-File App Implementation

The solution is delivered as a single Streamlit application (`app.py`) that contains:
- UI layer (layout, custom CSS, theme/language/style controls)
- Data layer (embedded default datasets loaded into Pandas DataFrames)
- Logic layer (search engine, OCR tooling, agent orchestration)
- Configuration management (agents.yaml and SKILL.md editors, standardization)
- Note Keeper subsystem (upload/paste + AI “Magics” + keyword coloring)

External files intentionally kept separate:
- `agents.yaml` (agent definitions)
- `SKILL.md` (global rules appended to agent prompts)
- `requirements.txt` (dependencies)

### 2.2 High-Level Data and Control Flow

1. **Startup**
   - Initialize session state (theme, language, style, text buffers, agent run history).
   - Load default embedded datasets into Pandas DataFrames.
   - Load `agents.yaml` and `SKILL.md` content from disk into editable sidebar panels.

2. **User Chooses Mode**
   - **Command Center**: PDF ingestion, trimming, OCR, dataset search, agent execution, final report compilation.
   - **AI Note Keeper**: paste/upload notes; transform into structured Markdown; highlight keywords.

3. **Search and Dashboard**
   - User enters a query in the global search bar.
   - The search engine executes fuzzy matching across 4 datasets.
   - The dashboard renders KPI tiles and a 360° view (K#, decision, MDR count, recall severity summary).

4. **Document Processing**
   - User uploads a PDF.
   - Optionally trims by page ranges (e.g., `1-5,10`).
   - Extracts text using PyPDF2 or performs OCR using Tesseract or Vision OCR (OpenAI/Gemini) on rendered images.

5. **Agent Orchestration**
   - User selects an agent from `agents.yaml`.
   - User can adjust provider/model/max tokens (default 12000), and edit prompts.
   - Agent uses:
     - `SKILL.md` + agent system prompt + user prompt + selected input text
   - Output is saved and rendered; user can edit output to become the next agent’s input.

6. **Final Report**
   - User edits or appends agent outputs into a single Final Report field.
   - Rendered view applies Coral highlighting (via HTML spans in the UI).

---

## 3. Technology Stack

### 3.1 Frontend/UI
- **Streamlit** for UI layout and state handling.
- Custom injected CSS implementing:
  - **Glassmorphism** cards
  - Accent color per painter style
  - Coral highlight styling
  - “Floating action button” visual effect

### 3.2 Data Processing
- **Pandas** for DataFrames and tabular display.
- **rapidfuzz** for fast fuzzy search and partial matching.

### 3.3 Document Processing
- **PyPDF2** for PDF reading and trimming.
- **pdf2image** + **poppler** for rendering PDF pages to images.
- **pytesseract** + **tesseract-ocr** for local OCR.

### 3.4 LLM Providers (Multi-API)
- **OpenAI** SDK
- **Google Generative AI** (Gemini) SDK
- **Anthropic** SDK
- **xAI** via OpenAI-compatible base URL (configurable by editing base_url if needed)

---

## 4. UI/UX Specification (WOW UI)

### 4.1 Visual Theme: “Painter’s Studio + Regulatory Canvas”
- Primary aesthetic: futuristic glass panels on obsidian backdrop (dark) or clean matte light backdrop (light).
- Accent: painter palette accent color used for non-critical UI decoration and actions.
- **Coral (#FF7F50)** reserved for critical regulatory signals and keyword highlighting.

### 4.2 Global Controls
- **Theme**: Light / Dark
- **Language**: English / Traditional Chinese (繁體中文)
- **Painter Style**: 20 famous painters, selectable; “Jackpot” randomizer selects one at random.

### 4.3 Top Status Bar (WOW Indicators)
- API Key badges:
  - Green dot: key managed by environment variable
  - Yellow dot: key provided in-session
  - Red dot: missing
- Dataset counters for four datasets.
- OCR status indicator (ready/empty).
- “Review Mana” progress bar based on agent run count (modulus scaling).

### 4.4 Layout: Split-Pane Workspace
**Left Pane: Source Material**
- PDF upload
- Page trim by range expression
- PDF preview via embedded iframe
- OCR engine selection:
  - PyPDF2 text extraction (fast)
  - Local OCR (Tesseract)
  - Vision OCR (OpenAI/Gemini, high fidelity for tables)
- Editors:
  - OCR text editor
  - Raw extracted text editor

**Right Pane: Intelligence Deck**
- Agent Outputs (run + history + editable chaining)
- Search Results (interactive tables + 360° summary)
- Final Report (edit + rendered view)

### 4.5 Mode Toggle
- **Command Center**: the main review workflow.
- **AI Note Keeper**: a focused workspace for note ingestion and AI-assisted organization.

---

## 5. Data Strategy and Default Dataset Specification

### 5.1 Embedded Datasets
The system ships with four embedded datasets (in Python lists) loaded into DataFrames:

1. **510(k)**: includes K-number, decision, device name, applicant, product code, predicates, summary.
2. **MDR/ADR**: includes adverse event ID, date, event type, outcome, device problem, brand, product code, UDI-DI, recall link, narrative.
3. **GUDID**: includes UDI-DI, brand, sterility, MRI safety, single use, implantable, latex presence, contact info.
4. **Recall**: includes recall number, class (I/II/III), reason, product code, distribution, status, affected lots.

### 5.2 Cross-Dataset Search (Context Engine)
Search is driven by a fuzzy matching engine:
- Query normalized to lowercase for matching.
- `rapidfuzz.fuzz.partial_ratio` used across configured columns per dataset.
- Results returned as ranked lists with scores and full record payload.

### 5.3 360° Device View Aggregation
From search results:
- Identify the top matching 510(k) record.
- Use its `product_code` to pull related:
  - Recall records
  - MDR/ADR records
  - GUDID records
- Derive a “top recall class” by severity priority (I > II > III).
- Present a consolidated card and KPIs.

---

## 6. PDF Processing and OCR Workflows

### 6.1 PDF Trimming
Users specify page ranges in a compact syntax:
- Examples: `1-5`, `10`, `1-2, 10, 12-14`
- Range parsing returns inclusive 1-based ranges.
- `PyPDF2.PdfWriter` constructs a trimmed PDF byte stream in memory.

### 6.2 Text Extraction (PyPDF2)
For text-based PDFs:
- Extract text per page.
- Join pages with separators.
- Store output in:
  - `raw_text`
  - `ocr_text` (initially mirrored for convenience)

### 6.3 Local OCR (Tesseract)
For scanned PDFs:
- Render pages into images via `pdf2image.convert_from_bytes`.
- OCR each page using `pytesseract.image_to_string`.
- Output is concatenated with `--- PAGE N ---` markers.

### 6.4 Vision OCR (OpenAI/Gemini)
For difficult layouts, tables, or low quality scans:
- Render pages into images.
- Encode images:
  - OpenAI: base64 PNG data URLs passed as `input_image`
  - Gemini: pass image object to model
- Prompt instructs the model to extract **plain text** while preserving table structure where possible.
- Output is combined with page markers for traceability.

---

## 7. Agent Orchestration Engine (Human-in-the-Loop)

### 7.1 Agent Configuration
Agents are defined in `agents.yaml` with a Pydantic-validated schema:
- `id`, `name`, `provider`, `model`, `temperature`, `max_tokens`, `system_prompt`, `user_prompt`

The app includes an “Upload + Edit + Standardize” workflow:
- YAML uploads supported.
- If missing provider/model/temperature/max_tokens, defaults are applied.
- Structure normalization supports flat list YAML into correct object shape.

### 7.2 Runtime Overrides (Per User Request)
Before execution, reviewers can override:
- Provider and model selection
- `max_tokens` (UI defaults to **12000**)
- System prompt and user prompt text (editable)

### 7.3 Chained Execution with Editable Outputs
- Each run produces an output stored in `st.session_state["agent_outputs"]`.
- Every output has an `edited_output` field:
  - Default equals output
  - User can modify in a text editor
- Next agent can use:
  - last edited output (preferred)
  - OCR text
  - raw extracted text

### 7.4 Prompt Assembly
At runtime, the final system prompt is assembled as:

`SKILL.md` + agent system prompt

The user prompt is assembled as:

agent user prompt + separator + selected input text

This preserves consistency rules while enabling per-run customization.

### 7.5 Provider Implementations
- OpenAI: `responses.create` with `max_output_tokens`
- Gemini: `GenerativeModel.generate_content` with `max_output_tokens`
- Anthropic: `messages.create` with system + user messages
- xAI: OpenAI-compatible call with `base_url="https://api.x.ai/v1"`

Errors are caught at UI level and shown to user; no secrets are printed.

---

## 8. AI Note Keeper (New Feature)

### 8.1 Ingestion
Users can:
- Paste text/Markdown
- Upload PDF/TXT/MD

PDF uploads use PyPDF2 extraction by default for speed.

### 8.2 Transformation and Editing
AI “Magics” produce structured Markdown that is:
- editable in a Markdown text area
- optionally rendered with Coral highlighting

### 8.3 Six AI Magics
1. Organize Note (Markdown)
2. Executive Summary
3. Action Items + Owners
4. Risk/Deficiency Finder
5. Compliance Checklist Generator
6. AI Keywords Highlighter (manual keyword+color mapping)

### 8.4 Keyword Highlighting Rules
- Baseline Coral highlighting uses an ontology list (e.g., warning, predicate, recall, latex).
- User keyword coloring allows custom emphasis colors layered on top.
- Output is rendered as HTML inside a glass card, enabling Coral spans.

---

## 9. Security and Privacy Specification

### 9.1 API Key Handling
- Environment variables supported:
  - `OPENAI_API_KEY`, `GEMINI_API_KEY`, `ANTHROPIC_API_KEY`, `XAI_API_KEY`
- If env key exists:
  - UI shows “Managed by System”
  - Key is never displayed
- If missing:
  - password input field is shown
  - stored only in `st.session_state["api_keys"]`
- Keys are never written to disk and never logged.

### 9.2 Data Handling
- PDFs and derived artifacts are processed in memory (bytes and images).
- User can clear session state via sidebar “Danger Zone” button.
- External API calls only send:
  - selected prompt text
  - selected input text
  - for Vision OCR: page images

---

## 10. Observability and Operational Behavior

### 10.1 Status Indicators
The top bar provides operational visibility:
- dataset counts
- OCR readiness
- provider key availability
- “Review Mana” progress (agent run activity indicator)

### 10.2 Failure Modes
Common failures:
- Missing system packages for OCR (`poppler`, `tesseract`)
- Invalid YAML structure for agents
- Missing API keys or model access
- Provider rate limits

The UI reports failures directly with error messages; session state remains intact unless user clears it.

---

## 11. Deployment Specification (Hugging Face Spaces)

### 11.1 Files
- `app.py` (this application)
- `agents.yaml` (user-provided; editable in sidebar)
- `SKILL.md` (user-provided; editable in sidebar)
- `requirements.txt` (Python deps)

Recommended system packages (via `packages.txt` on HF):
- `poppler-utils`
- `tesseract-ocr`

### 11.2 Resource Considerations
- OCR and Vision OCR are CPU/time heavy; trimming to relevant pages is encouraged.
- Fuzzy search across the sample dataset is fast; large-scale expansion may require indexing or vector search.

---

## 12. Limitations and Future Enhancements

### 12.1 Current Limitations
- Dataset scale: Pandas in-memory search is suitable for demo/small-medium datasets.
- Vision OCR cost/latency: depends on provider limits and image count.
- HTML rendering: Coral highlighting is string-based, not structural parsing.

### 12.2 Recommended Future Work
- Add vector database (Chroma/FAISS) for RAG across historical 510(k) summaries.
- Provide click-to-jump evidence linking from outputs back to PDF page view.
- Add PII/PHI redaction mode prior to any external API call.
- Implement robust table reconstruction and export workflows (CSV download).
- Add Mermaid rendering support in outputs for richer visual workflows.

---

## 13. Acceptance Criteria (Definition of Done)

1. App loads on HF Spaces with wide layout and no missing imports.
2. User can switch:
   - light/dark theme
   - English/Traditional Chinese
   - 20 painter styles + Jackpot
3. Default datasets load and show correct counts; global search returns results across all datasets.
4. 360° device view card appears for relevant queries (e.g., “StapleWave”, “GAG”, “K240305”).
5. PDF upload supports:
   - trimming by ranges
   - preview rendering
   - PyPDF2 extraction
   - Tesseract OCR
   - Vision OCR via OpenAI/Gemini when keys exist
6. agents.yaml is editable, uploadable, and standardized by Pydantic rules.
7. User can run agents one-by-one, override prompts/models/max_tokens, and edit outputs used for chaining.
8. AI Note Keeper supports paste/upload and runs all 6 AI Magics; Coral keyword highlighting is visible.
9. API keys are never displayed if provided by environment variables; session-provided keys are masked and not persisted.
10. Clearing session state resets UI and removes session-stored API keys and artifacts.

---
